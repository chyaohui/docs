> 关于 LVS 值班中问题处理流程总结说明，请各位值班同学针对自己遇到的各种情况进行补充或更新。

## 值班过程中告警通知
* 监控值班室 5666 电话通知 (他们以 "http://172.16.105.191/ping" 页面告警为准)
* 手机短信通知(5666 也会有通知)


## 针对告警问题的处理流程
可以参考下列流程，具体视情况而定：
* ping 告警 IP 地址
* ping 告警设备的内外网地址
* 尝试通道机登录告警设备
* 查看 zabbix 监控项，比如：CPU 使用率、bond0/bond1 流量图

针对具体排查结果：
* 如果单纯某个 IP 地址不通，可以选择多个机房进行 ping 测试(其它不同运营商机房)、[bench](http://bench.watch.monitor.sina.com.cn/new/probe/) 页面测试。如果确认网络不通，也可以适当做些本机的网络检查(是否有网口down、网关是否通等)；最后可以 QQ 联系 5666 咨询网络组值班人员，联系网络值班帮忙排查(提供不通源目的IP 和 traceroute 记录)。

* 如果 LVS 服务器内外网不通、登录不上、且监控数据异常中断，如无特殊情况一般视为宕机。QQ 联系 5666 值班室，让其联系相关人员进行服务器重启(一般会让我们提重启提案)。

* 如果重启失败，5666 一般会简单提供一些错误信息(如电源模块问题等)。非上班时间，如果重启失败，应该及时联系 IM @朱兴，请协调值班同学协助深入排查和解决宕机问题，并及时通知晓栋等相关人员。

* 如果确认服务器故障，是 `LVS` 服务器单点情况，不能立即恢复，则应该邮件通知相关业务管理员，通知其关注服务；并在 「运维故障通报组（限运维内部使用）」微信群中通知，同时让 5666 务必电话通知到各位管理员知晓。如故障有新进展或服务器已恢复，则需再次通知相关人员。通知格式参考但不拘泥于如下格式：

> @朱建平 @noc-萌妹纸 @5666值班 @邱春武 ， 通报一起事件：赛尔机房一台 LVS 晚上再次出现硬件宕机，且无法重启的情况，经 5666 联系现场人员查看，疑似电源故障。 目前赛尔所有 VIP 都是 LVS 单机运行风险，请各位管理员密切关注 VIP 可用性。@朱兴 ，请帮忙看下是否可协调人员排查下宕机原因，感谢！

> 注：如果我们对于故障，曾提前采取过预防措施，也切记一并补充进去，例如：“我们昨天已申请领用供保 LVS 备机，目前上线流程进行中”

* 如果故障服务器是 `ha` 或 `ssl` 集群模式，在不影响服务(流量负载都没问题)的情况下，可以不用紧急处理，走故障协查 -> 设备报修的流程即可。

* 故障时联系人员
  - 服务器宕机需要重启等问题 —— 联系：值班室5666 (电话：01062675666)
  - 服务器故障修复等问题 —— 联系：IM组值班人员
  - 网络故障不通等问题 —— 联系：网络组值班人员

## 确定服务器问题
请 IM 同事协查服务器故障的具体原因：
* 如果是较新机器，可以选择报修，替换故障部件
* 如果是老旧机器，无法维修，可以选择使用机房故障备机的部件替换
* 如果是老旧机器，无法维修，且没有故障机可以替换备件，则需要一台完整的备机来替

注：如果如果服务器上的服务比较复杂，难迁移，我们优先选择用一台备机来替换掉故障机，而不是手动迁移 vip。

## 申请协调相关服务器资源
**一般可以先从 IM 组协调是否有备机或备件；如果没有就选择向成本中心借用服务器**。

* 确定服务器型号
* 确定服务器所需网卡数量和类别(千兆或万兆)
* 确定操作系统
* 确定服务器上所存在的服务类型：LVS、HL、SNAT等。
* 出现故障，优先按照该思路来考虑
  - 根据故障机出现问题的硬件，请 IM 协调是否能找到对应适配的正常硬件，替换即可
  - 如果没有合适硬件来替换，尝试请 IM 协调一台类似机型的备用服务器，如果能找到，优先尝试更换原始硬盘(如果能启动就基本不用其它操作，恢复服务最简单高效)，不过也有可能更换硬盘不能正常启动。
  - 如果协调到备机且更换硬盘有问题，那么可以尝试给备机重装操作系统，重新初始化，重新配置相关服务
  - 如果以上方案不行的话，尝试走下边的步骤。
* 如果有备机，直接协调上线，更换故障服务器原有服务器配置
  - 上线提案
  - 快递备件(网卡等)
* 如果没有备机，通过 [鸡爪](http://jira.intra.sina.com.cn) 来建立借用提案
  - 可以参考之前建立的 jizhua 借用<[提案](http://jira.intra.sina.com.cn/browse/DEVICE-114)>
  - 确认借用机型、时间、原有设备盘点号、借用原因。
  - 如果库存有所需服务器机型，确定库存位置。
  - 然后进行上线提案 (快递备件/快递服务器等)。

* 恢复故障机服务
  - 初始化替换机器
  - 复制原有机器的相关网络配置(需要停掉原有故障机网络)，前提需要备份故障机网络配置

