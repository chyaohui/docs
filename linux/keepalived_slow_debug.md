# 记录keepalived生效慢的DEBUG过程

## 一、问题起因
教育网-赛尔机房 LVS 服务器被攻击，需要调整 VIP 等信息，发现 `kill -HUP $pid` 后生效速度非常慢，延迟时间大概有 5-10 秒左右。比如添加或删除一个 member，通过 `ipvsadm -ln -t vip:vport` 查看会有这么长时间的延时。

## 二、系统环境
* 操作系统：CentOS 5.4
* 内核版本：2.6.32-220.23.1.sina8.2.el5.x86_64
* keepalived版本：keepalived_LVS-1.2.2-6

## 三、最初的排查
1. 问题复现，重复多次调整member进行测试，基本确定问题现象。

2. 查看当时系统负载：负载很低，CPU各项参数值都很小，查看内存，磁盘IO，网络IO，日志都无果。

3. 起初怀疑可能是教育网络不好，且有一些FULLNAT的配置(可能跨机房)和公网IP的member配置，当时脚本测试了各member的网络连通性，发现网络延时整体较小，确定网络可能不是主要原因。

4. 为了验证是否是系统环境影响，将赛尔的lvs.conf配置文件拿到本地环境进行测试，以及在其它整体配置一致的永丰yfg2备机进行，测试发现生效速度比较快。可以简单的说明是赛尔机器整体环境是有问题的，具体原因可能与赛尔本身的系统环境有关，但具体什么问题待查。

5. 使用 strace 工具进行查看。当时只能追踪到当时系统的一些系统调用的信息和运行过程的流程，没有看出什么异常信息。只发现赛尔的keepalived版本使用的select异步模型，但应该也不是这个原因。

## 四、改变思路
### A、分析keepalived.log日志文件
1. 其实仔细分析 keepalived.log 文件，执行reload后，配置文件中可以发现记录条目速度比较慢，比如每秒钟能activing checker才20多个，显然是比较慢的，值得怀疑。

2. 对比永丰机房服务器相关数据。通过查看永丰等服务器日志数据分析，发现keepalived在reload时候速度是很快的，基本时间是在1s内。

3. 仔细分析keepalived.log日志。换一种思路分析，可以看出keepalived.log中日志能够大致分为几个阶段，我们可以针对每个阶段消耗的具体时间进行统计，然后可以针对每个阶段的时间来进行再次分析。比如分析每个阶段都有哪些操作或动作，这些操作的耗时情况，当然也可以根据这些阶段分析的时间值考虑为后续优化提供思路和数据依据。

### B、将reload分为几个步骤
1. 加载配置文件后，与上次配置作diff(两次链表做对比)   8秒
2. 将各个VS加到lvs服务中   4秒
3. 激活健康检查：其实是注册各个checker的timer到链表中，尚未作连接进行健康检查     30秒
4. 再次做健康检查，将failed的realserver服务器摘除     10秒

大概分为几个阶段，并统计各个阶段的时间后，对比这几个阶段时间与在其他机房服务器处理对应的时间，发现yf等机房的数据整体在1-2秒之内，对比赛尔的延时，相差甚远。

### C、具体分析各阶段的代码
仔细分析前3个阶段的代码，发现代码中并未有太多耗时的操作，且都未涉及到网络IO，耗时缺很异常。

1. 刚开始怀疑机器老旧，性能不行？于是简单写了循环程序，测试对比其它机器，发现性能还不错。

2. 又通过strace工具分析统计HUP时的系统调用情况，初步发现可疑情况：`sendto()` 调用耗时很长，它是用来写日志的，但是当时觉着可能性不大，因为记录的数量不大，不至于这么影响性能。

### D、实际代码测试统计运行时间
1. 整理了一下keepalived的整体流程，为了避免对线上环境的影响，只将keepalived中的几个阶段代码保留，并针对每个阶段打上时间戳，编译后在赛尔机器上运行测试。

2. 首先测试来确定，用本次代码时各阶段时间与原程序统计的时间基本一致。

3. 然后，修改代码中统计时间的点，最终定位到调用log_message()函数式耗时较长

4. 再次，注释掉log功能，进行测试，发现时间骤减到1秒左右，基本定位在写日志这里。

5. 再次验证，将syslog.conf中的log文件去掉，restart后，运行测试程序，时间1秒

### E、确定是syslog的问题
1. 现在能证实keepalived向syslogd写日志确实会很慢，那其它程序写syslog日志会不会很慢呢?

2. 编写脚本使用logger模拟向syslogd写入1000条日志数据，运行时间大概40秒左右，与keepalived的时间大概一致，基本说明syslogd是有问题。

### F、确定syslog的具体问题
现在基本定位问题出在syslogd服务上，但具体什么原因还未知，于是又作了如下测试：
1. 使用strace工具分析syslogd程序，同时模拟向syslog写日志，统计出有异常问题：fsync调用耗时极高
2. fsync函数作用是将内存中数据刷入硬盘，那fsync慢，就怀疑硬盘是否问题?
3. 测试磁盘是否有坏(脚本检测没有发现错误)

### G、确定是否硬盘问题
初步怀疑是磁盘有问题写入速度很慢。于是针对以下两种情况做了测试：
1. 日志使用原来的keepalived.log磁盘文件
2. 日志文件不落地到磁盘文件，写入一个内存文件系统的文件/mnt/tmpfs/keepalived.log(在内存中存储)

> 测试数据：keepalived.log普通磁盘文件写入时间40秒  内存文件tmpfs写入时间<１秒

对比下其它机器yf等服务器进行测试，结果速度也非常快。

为了确定确实是硬盘速度问题，针对硬盘进行了如下两种测试：
1. 使用dd命令，生成1GB的文件，速度为300M/s，其它机器测试速度为500M/s
2. 测试小数据，通过脚本echo "xxx"模拟多次向keepalived.log文件追加数据1000次，时间<1秒

通过测速发现，硬盘的速度问题也不是太大，而且这时还不能排除系统问题

## 五、发现其它问题
通过全网找了几台CentOS 5.4的lvs服务器，通过测试，发现这些服务器也有类似情况，写入syslog速度非常慢。而且测试kill -HUP 时，生效也是很慢，情况与赛尔基本一致，貌似5.4系统都是这个问题?

>再次对比没有此问题

1. 通过对比yf等正常的机器，发现内核版本完全一样，而syslogd版本的小版本号不一致。
2. syslogd程序的rpm包名称是：`sysklogd` 查询方式：`rpm -qf /sbin/syslogd`
  
> 升级syslogd程序

  ```sh
  yum install sysklogd
  ```
  升级并确认syslogd之后，restart，再次测试，但是写入速度仍然非常的慢。不知道为啥，可能不是syslogd版本问题?

> 换syslogd为rsyslogd程序

尝试安装rsyslogd程序，安装完毕后，syslogd貌似会被自动删除，通过配置，启动rsyslogd程序。

1. 使用脚本初步测试，发现写入速度正常了，时间<1秒。
2. 线上赛尔机器，再次尝试kill -HUP keepalived程序，测试发现生效速度非常快，整体生效过程的时间小于1秒种。

> 问题解决
虽然没有彻底搞清楚具体syslogd程序到底是什么原因，但是更换rsyslogd后确实解决了这个问题，结束。
